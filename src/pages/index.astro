---
import Layout from "@layouts/Layout.astro";
import SkipLink from "@utils/SkipLink.astro";
import Workshops from "@components/Workshops.astro";
import { getFormattedDates, ScheduleResponse } from "~/lib";
import Navigation from "@utils/Navigation.astro";
import Hero from "@components/Hero.astro";
import Footer from "~/components/Footer.astro";
import { GSCRIPT_IMPL_ID } from "astro:env/server";

const res = await fetch(
  `https://script.google.com/macros/s/${GSCRIPT_IMPL_ID}/exec`
);
const resData = await res.json();

console.dir(resData, { depth: null });

const { data } = ScheduleResponse.assert(resData);

const startDate = "27-12-2025";
const endDate = "04-01-2026";
const formattedDates = getFormattedDates(startDate, endDate);
---

<Layout title="NYNT Schedule 25/26">
  <SkipLink />
  <div class="sr-only" id="start"></div>
  <Hero />
  <main id="main">
    {
      formattedDates.map(({ day, month, year }) => {
        const schedule = data[day];
        return (
          <section class="schedule" id={day}>
            <div class="schedule-heading">
              <p class="heading-day">{day}</p>
              <p class="heading-month-year">
                {month} {year}
              </p>
            </div>
            <div class="schedule-content">
              {schedule.times.map(([time, label]) => {
                const isWorkshop = typeof label !== "string";

                if (isWorkshop) {
                  return (
                    <>
                      <p class="workshop-time">{time.split("-").join(" - ")}</p>
                      <Workshops data={label} />
                    </>
                  );
                }

                return (
                  <div
                    class:list={{
                      round: true,
                      accent:
                        label.includes("Talent") || label.includes("New Year"),
                      meal:
                        label.includes("Lunch") ||
                        label.includes("Dinner") ||
                        label.includes("Breakfast"),
                    }}
                  >
                    <p class="time">{time.split("-").join(" - ")}</p>
                    <p class="label">{label}</p>
                  </div>
                );
              })}
            </div>
          </section>
        );
      })
    }
  </main>
  <Footer />
  <section aria-label="Utilities">
    <Navigation />
  </section>
</Layout>

<style>
  :root {
    --time-width: 100px;
  }

  #main {
    padding-bottom: var(--space-3xl);
  }

  .schedule {
    padding: var(--space-s) var(--space-xs);
    max-width: 900px;
    margin: 0 auto;
  }

  .schedule-heading {
    font-family: var(--bbh-sans-bartle);
    font-style: normal;
    font-weight: 800;
    text-align: center;
    color: var(--color-red-900);
  }

  .heading-day {
    font-size: 48px;
    line-height: 100%;
    letter-spacing: 0;
    font-family: inherit;
  }

  .heading-month-year {
    font-size: 12px;
    line-height: 100%;
    letter-spacing: 2px;
    font-family: inherit;
  }

  .schedule-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-4xs);
    margin-top: var(--space-s);
  }

  .workshop-time,
  .time {
    color: var(--color-black);
    font-family: var(--fira);
    font-weight: 600;
    font-size: 14px;
  }

  .workshop-time {
    padding: 6px 10px;
  }

  .round {
    display: flex;
    flex-direction: column;
    align-items: baseline;

    padding: 10px;
    background: var(--color-neutral-light);

    .label {
      font-size: 18px;
      font-weight: 500;
      font-family: var(--fira);
    }

    &:has(.workshops) {
      background: var(--color-white);
      padding: 0 var(--space-s);
    }
  }

  .meal {
    background: var(--color-red-100);
  }

  .accent {
    background: var(--color-orange);
    .label {
      position: relative;
      &::before {
        content: url("/firework.svg");
        position: absolute;
        top: 50%;
        transform: translateY(-48%);
        right: calc(100% - 52px);
      }
      &:after {
        content: url("/stars.svg");
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: calc(100% + var(--space-4xs));
        width: 24px;
        height: 24px;
      }
    }
  }
</style>

<script is:inline>
  window.addEventListener("DOMContentLoaded", () => {
    const menuElements = document.querySelectorAll(".nav-day");
    const sections = new Map();
    let latestMostVisibleSection = null;

    const targetDay = new URLSearchParams(window.location.search).get("day");

    const today = new Date();
    const dayOfMonth = today.getDate();
    const month = today.getMonth();

    // Scroll to today's date if within event range (Dec 27 - Jan 4)
    const isInEventRange =
      (month === 11 && dayOfMonth >= 27) || (month === 0 && dayOfMonth <= 4);

    if (targetDay || isInEventRange) {
      const dayElement = document.getElementById(
        String(targetDay || dayOfMonth).padStart(2, "0")
      );
      if (dayElement) {
        dayElement.scrollIntoView({
          behavior: "smooth",
          block: "start",
        });
      }
    }

    const hero = document.getElementById("hero");
    const footer = document.getElementById("footer");

    // Observer for schedule sections
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry, index) => {
          sections.set(entry.target.id, entry.intersectionRatio);
        });

        // Determine the most visible section
        let mostVisible = null;
        sections.forEach((ratio, id) => {
          if (!mostVisible || ratio > mostVisible.intersectionRatio) {
            const element = document.getElementById(id);
            mostVisible = { id, intersectionRatio: ratio };
          }
        });

        if (
          mostVisible &&
          mostVisible.intersectionRatio > 0.4 &&
          latestMostVisibleSection !== mostVisible.id
        ) {
          latestMostVisibleSection = mostVisible.id;

          menuElements.forEach((el) => el.classList.remove("active"));

          if (["hero", "footer"].includes(mostVisible.id)) return;
          const menuElement = document.getElementById(`menu-${mostVisible.id}`);
          if (!menuElement) return;
          menuElement.classList.add("active");
        }
      },
      {
        threshold: [0, 0.2, 0.4, 0.6, 0.8, 1],
      }
    );

    document.querySelectorAll("section.schedule").forEach((section) => {
      observer.observe(section);
    });
    if (hero) observer.observe(hero);
    if (footer) observer.observe(footer);
  });
</script>
